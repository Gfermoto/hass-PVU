# hass-PVU
## Система автоматизации приточно-вытяжной вентиляции (ПВУ)

### Описание
Данный проект представляет собой готовое решение для автоматизации приточно-вытяжной вентиляции на базе Home Assistant с использованием оборудования Turkov. Система обеспечивает комфортный микроклимат в помещении, оптимизируя энергопотребление и качество воздуха.

### Changelog

История изменений перенесена в отдельный файл: [`CHANGELOG.md`](./CHANGELOG.md).

### Компоненты системы
1. **Контроллер**: Home Assistant
   - Версия: 2023.12.0 или новее
   - Рекомендуется установка на выделенное устройство

2. **Вентиляционная установка**: 
   - Производитель: Turkov
   - Модель: с рекуперацией тепла и влаги (3 ступени рекуперации)
   - Рабочий диапазон температур: до -35°C
   - Подключение: **ModBus RTU по IP** и/или **MQTT** (Wi‑Fi модуль, прошивка 2.0.0+)

   **Референс конфигурации для текущего blueprint**:
   - Установка: **Zenit Heco V 350 1,5E (EPP)**.
   - Дополнительно: внешний охладитель + электрический нагреватель.
   - Рекомендуемые режимы HVAC в автоматизации: `off`, `fan_only`, `heat`, `cool` (без `dry`).

3. **Интеграция Turkov** (один из вариантов):
   - **[hass-turkov](https://github.com/alryaz/hass-turkov)** — по IP (ModBus RTU), climate-сущность в HA
   - **MQTT** — топики вида `turkov/<серийный_номер>/...`, см. раздел «Подключение Turkov по MQTT» ниже

4. **Датчик качества воздуха**: [AirGradient](https://www.airgradient.com/)
   - Измеряемые параметры:
     * CO₂ (0-40000 ppm)
     * Температура (-10 до +60°C)
     * Относительная влажность (0-100%)
     * PM2.5, VOC Index, NOx Index (опционально, в любой комбинации)
     * Для расширенной логики можно использовать как внутренние, так и наружные сенсоры
   - Возможности:
     * WiFi подключение
     * MQTT интеграция
     * Открытый исходный код
     * DIY сборка или готовое решение

### Функциональные возможности

#### 1. Автоматическое управление режимами работы
- **Режим обогрева**:
  * Активируется при температуре наружного воздуха ниже заданной (+5°C на улице и в помещении не более +25°C)
  * Если температура воздуха в помещении выше +25°C, отопление временно отключается до достижения +23°C
  * Использует рекуперацию тепла
  * Защита от обмерзания теплообменника
  
- **Режим вентиляции**:
  * Основной режим работы
  * Адаптивная скорость вентиляторов
  * Байпас рекуператора при благоприятных условиях
  
- **Режим охлаждения**:
  * Активируется при температуре в помещении выше +25°C
  * Работает только при температуре наружного воздуха выше +18°C
  * При более низкой температуре наружного воздуха переключается в режим вентиляции и рекомендует естественное проветривание
  * Использование естественного охлаждения
  * Защита от конденсации

#### 2. Управление на основе качества воздуха
- **Мониторинг CO₂**:
  * Пороговые значения:
    - Нормальный уровень: до 600 ppm (ночь), до 800 ppm (день)
    - Предупреждение: 800-1200 ppm
    - Интенсивная вентиляция: более 1200 ppm
  
- **Мониторинг влажности**:
  * Пороговые значения:
    - Комфортный уровень: 40-60%
    - Предупреждение: 60-70%
    - Интенсивная вентиляция: более 70%
  * Защита от конденсации:
    - Автоматическое включение вентиляции при влажности выше 70%
    - Увеличение скорости вентиляторов при влажности выше 80%
  * Учет температуры:
    - Корректировка порогов влажности в зависимости от температуры
    - Предотвращение образования конденсата

- **Мониторинг PM2.5** (опционально):
  * Пороговые значения:
    - Нормальный уровень: до 25 µg/m³
    - Предупреждение: 25-50 µg/m³
    - Критический уровень: более 50 µg/m³
  * Защитные меры:
    - При уровне PM2.5 выше 50 µg/m³:
      * Отправка уведомления в Telegram
      * Рекомендация проветрить помещение естественным путем
    - При уровне PM2.5 выше 100 µg/m³:
      * Блокировка запуска вентиляции
      * Экстренное уведомление
      * Рекомендация проветрить помещение естественным путем
      * Рекомендация провести влажную уборку
  * Интеграция с уведомлениями:
    - Автоматические сообщения в Telegram
    - История измерений
    - Рекомендации по улучшению качества воздуха
  
- **Алгоритм управления**:
  * Плавное изменение скорости вентиляторов
  * Учет времени суток
  * Приоритет комфорта/энергосбережения
  * Комплексный анализ CO₂, влажности и PM2.5

#### 3. Специальные режимы работы
- **Ночной режим**:
  * Время активации: настраиваемое (по умолчанию 23:00 - 07:00) Ночной тариф
  * Снижение скорости вентиляторов до 30%
  * Пониженный порог CO₂ для включения вентиляции
  
- **Режим "Отсутствие"**:
  * Минимальная вентиляция
  * Поддержание базового воздухообмена
  * Защита от накопления влаги

#### 4. Система защиты от конфликтов
- Блокировка одновременной работы отопления и охлаждения
- Приоритеты режимов:
  1. Защита от обмерзания
  2. Контроль влажности
  3. Температурный комфорт
  4. Энергосбережение

### Установка и настройка

1. **Установка Home Assistant**:
   ```bash
   # Следуйте официальной инструкции на
   # https://www.home-assistant.io/installation/
   ```

2. **Установка интеграции Turkov** (по IP):
   - Добавьте репозиторий в HACS
   - Установите интеграцию
   - Перезагрузите Home Assistant

   **Подключение Turkov по MQTT** (альтернатива или дополнение к IP):
   - Документация: [Turkov — подключение по MQTT](https://turkov.ru/blog/articles/podklyuchenie_oborudovaniya_k_sistemam_umnyy_dom_po_protokolu_mqtt/)
   - Нужен Wi‑Fi модуль с прошивкой **2.0.0** и выше.
   - Базовый путь топиков: **`turkov/<серийный_номер>/...`** (серийный номер вида `X-XXXXXX-XX`, указан на устройстве и в веб-интерфейсе `http://turkov-X-XXXXXX-XX.local/`).

   **Топики состояний** (устройство публикует):
   | Топик | Описание |
   |------|----------|
   | `turkov/<serial>/status` | Подключение: `online` / `offline` |
   | `turkov/<serial>/state/on` | Вкл/выкл |
   | `turkov/<serial>/state/fan_speed` | Скорость вентиляторов |
   | `turkov/<serial>/state/fan_mode` | Режим вентиляторов |
   | `turkov/<serial>/state/temp_sp` | Уставка температуры |
   | `turkov/<serial>/state/indoor_temperature` | Температура в помещении |
   | `turkov/<serial>/state/outdoor_temperature` | Температура с улицы |
   | `turkov/<serial>/state/supply_temperature` | Температура притока |
   | `turkov/<serial>/state/indoor_humidity` | Влажность в помещении |
   | `turkov/<serial>/state/filter` | Загрязнение фильтров |

   **Топики команд** (HA публикует для управления):
   - `turkov/<serial>/command/...` — подтопики обычно совпадают с именами из state (например `on`, `fan_speed`, `fan_mode`, `temp_sp`). Точный формат значений смотрите в документации Turkov или в исходящих сообщениях при управлении с веб-интерфейса/приложения.

   **Встроенный CO2-датчик Turkov (пример для вашей установки):**
   - Для чтения встроенного датчика CO2 нужен настроенный MQTT-брокер (Mosquitto/EMQX и т.п.), к которому подключен Wi-Fi модуль установки.
   - Для установки с примерным серийным номером `2-400187-01` используйте топик:
     - `turkov/2-400187-01/state/CO2_level`
   - Если у вас разнесенная конфигурация через `!include`, это нормально: ниже пример именно блока сенсора, который можно положить в отдельный файл и подключить через include.
   - Минимальный рабочий пример сенсора:
   ```yaml
   mqtt:
     sensor:
       - name: "Turkov_CO2"
         state_topic: "turkov/2-400187-01/state/CO2_level"
         device_class: carbon_dioxide
         state_class: measurement
         unit_of_measurement: "ppm"
   ```

   После настройки MQTT в HA можно завести сенсоры по state-топикам и при необходимости управление через сервис `mqtt.publish` в топики `command/...`. Blueprint `pvu.yaml` рассчитан на climate-сущность (из hass-turkov); при использовании только MQTT нужно либо поднять climate через [MQTT Climate](https://www.home-assistant.io/integrations/climate.mqtt/) с этими топиками, либо доработать автоматизацию под прямые вызовы `mqtt.publish`.

3. **Настройка AirGradient**:
   - Подключите датчик к сети WiFi
   - Настройте MQTT брокер
   - Добавьте сенсоры в Home Assistant

4. **Импорт Blueprint**:
   - Скопируйте файл `pvu.yaml` в папку `blueprints/automation/`
   - Импортируйте через интерфейс Home Assistant

   **Требования к датчикам в `pvu.yaml`**:
   - **Обязательные**: температура в помещении и влажность в помещении.
   - **Опциональные**: все остальные (внутренние и наружные CO₂ / PM2.5 / VOC / NOx, наружная температура, presence).
   - Система работает с любой комбинацией опциональных сенсоров.

   **Поведение blueprint** (`pvu.yaml`):
   - Приоритет выше у **внутренних** датчиков качества воздуха.
   - **Наружные** датчики используются как корректирующий фактор (ограничение слишком агрессивного boost при плохом наружном воздухе).
   - Для температуры и качества воздуха используется гистерезис (включение/возврат по разным порогам), чтобы избежать «дребезга».
   - Скорость вентилятора управляется в 3 ступенях: `low` -> `medium` -> `high` (и ограничивается до `medium` при плохом наружном воздухе).
   - HVAC-переключения выполняются только в валидные режимы, поддерживаемые сущностью `climate`.
   - Реакция на обязательные датчики — по их изменению, плюс периодический пересчет по таймеру каждые 2 минуты.
   - Интерфейс blueprint в HA организован по блокам: устройство и обязательные датчики -> опциональные датчики -> расписание -> температуры и гистерезис -> пороги качества воздуха -> режимы устройства.

   **Важно про VOC/NOx в AirGradient**:
   - Это индексы (обычно шкала 1–500), а не абсолютные концентрации газов.
   - NOx Index часто близок к 1 в «чистом» фоне; рост выше 1 означает ухудшение относительно базовой линии.
   - Значения NOx 2–3 обычно не считаются тревожными; для автоматических триггеров практичный стартовый порог — около 20.
   - В проекте пороги можно адаптировать под ваш реальный профиль помещения.

### Конфигурация

1. **Основные параметры** (`configuration.yaml`):
   ```yaml
   # Пример базовой конфигурации (Turkov по IP через hass-turkov)
   climate:
     - platform: turkov
       name: "PVU"
       modbus_host: 192.168.1.x
       modbus_port: 502

   sensor:
     - platform: mqtt
       name: "CO2 Level"
       state_topic: "airgradient/co2"
       unit_of_measurement: "ppm"
     - platform: mqtt
       name: "Humidity"
       state_topic: "airgradient/humidity"
       unit_of_measurement: "%"
     - platform: mqtt
       name: "PM2.5"
       state_topic: "airgradient/pm25"
       unit_of_measurement: "µg/m³"

   notify:
     - platform: telegram
       name: "Telegram Notifications"
       chat_id: "YOUR_CHAT_ID"
       default_message: "Уведомление от системы вентиляции"
   ```

   **Пример сенсоров Turkov по MQTT** (подставьте свой серийный номер вместо `X-XXXXXX-XX`):
   ```yaml
   mqtt:
     sensor:
       - name: "Turkov температура в помещении"
         state_topic: "turkov/X-XXXXXX-XX/state/indoor_temperature"
         unit_of_measurement: "°C"
         device_class: temperature
       - name: "Turkov влажность в помещении"
         state_topic: "turkov/X-XXXXXX-XX/state/indoor_humidity"
         unit_of_measurement: "%"
         device_class: humidity
       - name: "Turkov температура с улицы"
         state_topic: "turkov/X-XXXXXX-XX/state/outdoor_temperature"
         unit_of_measurement: "°C"
         device_class: temperature
       - name: "Turkov статус"
         state_topic: "turkov/X-XXXXXX-XX/status"
   ```

2. **Автоматизации** (`automations.yaml`):
   ```yaml
   # Примеры будут добавлены позже
   ```

### Требования

1. **Аппаратные**:
   - Home Assistant с процессором ARM/x86
   - 2GB RAM минимум
   - Стабильное подключение к сети
   
2. **Программные**:
   - Home Assistant OS/Core
   - MQTT брокер
   - HACS

### Поддержка и обратная связь
- GitHub Issues: [создать обращение](https://github.com/your-repo/hass-PVU/issues)
- Telegram каналы:
  * [DIYIoT_Lab](https://t.me/DIYIoT_Lab) - Новости и обновления проекта
  * [DIYIoT_Zone](https://t.me/DIYIoT_Zone) - Сообщество разработчиков и энтузиастов

### Лицензия
MIT License
