# Tuning порогов по реальным данным

Цель: за 3-7 дней откалибровать пороги `CO2/PM2.5/VOC/NOx` под конкретное помещение, чтобы снизить лишние переключения и сохранить комфорт.

## 1) Подготовка (день 0)

- Оставьте `pvu.yaml` в рабочем режиме, включите `debug_mode` на время калибровки.
- Убедитесь, что в Recorder сохраняются:
  - `temp_indoor`, `humidity_indoor`;
  - внутренние `CO2/PM2.5/VOC/NOx` (что есть);
  - наружные `CO2/PM2.5/VOC/NOx` (если есть);
  - `climate`-сущность Turkov (`hvac_mode`, `fan_mode`).
- Для стабильности оставьте неизменными:
  - `temp_hysteresis_on`;
  - `outdoor_temp_policy`;
  - `hvac_min_switch_minutes`.
  - `climate_profile` и `home_profile` (меняйте только после завершения базовой калибровки).

## 2) Сбор данных (дни 1-3)

- Наблюдайте минимум 72 часа с обычным режимом жизни (сон/день/проветривания/готовка).
- Отметьте 3 типа эпизодов:
  - **пики загрязнения** (готовка, гости, закрытые окна);
  - **фоновый уровень** (ночь, пустая квартира);
  - **ложные разгоны** (вентилятор ускорился, но по ощущениям это не требовалось).
- В конце каждого дня фиксируйте:
  - максимумы и медианы по каждому датчику;
  - сколько раз `fan_mode` уходил в `medium/high`;
  - были ли частые переключения, ухудшающие комфорт.

## 3) Первичная настройка порогов

Рекомендуемая логика (без резких шагов):

- `*_high` ставьте немного выше типичного "рабочего фона".
- `*_low` ставьте на 15-35% ниже соответствующего `*_high` (гистерезис, чтобы избежать дрожания).
- Для наружных ограничителей `*_outdoor_block`:
  - если наружный воздух часто грязный, поднимите порог мягко (не более 10-20% за итерацию);
  - если разгон слишком агрессивный при грязной улице, слегка снизьте порог.

Практичный старт по шагу изменения:

- CO2: по 50-100 ppm;
- PM2.5: по 5-10 ug/m3;
- VOC/NOx: по 5-20 пунктов индекса.

## 4) Проверка после правок (дни 4-7)

- После каждого изменения дайте системе поработать минимум 24 часа.
- Считайте изменение удачным, если одновременно:
  - меньше "пустых" разгонов в `medium/high`;
  - нет ухудшения по ощущениям/CO2;
  - нет избыточной "пилы" по режимам.
- Если стало хуже, откатите только последний шаг и уменьшите размер следующего изменения вдвое.

## 5) Критерии "пороги валидированы"

- Не менее 3 дней без явных ложных разгонов.
- CO2 большую часть времени в целевой зоне (ваш выбранный порог).
- Переключения `fan_mode` выглядят предсказуемо и объяснимо по графикам.
- `debug_mode` не показывает систематических блокировок/аномалий без причины.

## 6) Что удобно вывести на Lovelace

- Графики: внутренние/наружные `CO2`, `PM2.5`, `VOC`, `NOx`.
- График `fan_mode` и `hvac_mode`.
- История `persistent_notification` (на время калибровки).
- Карточка с текущими порогами (`*_high`, `*_low`, `*_outdoor_block`).

Готовые шаблоны постоянных дашбордов:

- [`airflow_dashboard.yaml`](../airflow_dashboard.yaml)
- [`airflow_dashboard_min.yaml`](../airflow_dashboard_min.yaml)
- [`airflow_card.yaml`](../airflow_card.yaml) (для `Manual card`)
- [`airflow_card_min.yaml`](../airflow_card_min.yaml) (для `Manual card`)
- [`airflow_kpi_package.yaml`](../airflow_kpi_package.yaml) (KPI-верификация порогов)

Как применить:

1. В Home Assistant откройте **Настройки -> Панели управления -> Редактировать в YAML**.
2. Скопируйте содержимое файла `airflow_dashboard.yaml` (или `airflow_dashboard_min.yaml` для облегченного варианта).
3. Замените `entity_id` под свои сущности (`climate.pvu`, `sensor.indoor_*`, `sensor.outdoor_*`).
4. Сохраните и наблюдайте 3-7 дней по шагам из этого документа.

Если хотите вставить не целый дашборд, а одну карточку в существующую панель:

1. Откройте **Добавить карточку -> Manual card**.
2. Используйте `airflow_card.yaml` или `airflow_card_min.yaml`.
3. Не вставляйте туда `airflow_dashboard.yaml`/`airflow_dashboard_min.yaml`, иначе получите ошибку `No card type configured`.

## 7) KPI-пакет для закрытия верификации

Чтобы верификация была не "на глаз", подключите:

- [`airflow_kpi_package.yaml`](../airflow_kpi_package.yaml)

Что дает пакет:

- `sensor.airflow_co2_ok_percent_24h`
- `sensor.airflow_pm25_ok_percent_24h`
- `sensor.airflow_voc_ok_percent_24h`
- `sensor.airflow_nox_ok_percent_24h`
- `sensor.airflow_boost_fan_percent_24h`

Это позволяет объективно сравнивать изменения порогов по суткам и закрывать проверку на реальных данных.

## 8) Важные замечания

- VOC/NOx в AirGradient обычно индексные величины, а не абсолютная концентрация газа.
- Не меняйте много параметров одновременно: 1-2 порога за итерацию.
- В зимний период сначала контролируйте безопасность (`outdoor_temp_policy`, антизаморозка), потом уже "агрессивность" вентиляции.
