# Как я довел автоматику ПВУ Turkov в Home Assistant до состояния "можно жить"

Привет, Хабр.

Если коротко: это не "еще один yaml для умного дома". Это история про то, как довести автоматику до состояния, когда она не подводит в обычной жизни: держит комфорт, следит за воздухом и не делает опасных переключений зимой.

Показываю практический путь: как превратить "почти рабочую" автоматику ПВУ Turkov в предсказуемый релиз для реальной эксплуатации.

Проект: <https://github.com/Gfermoto/hass-PVU>

## Кому будет полезно

- владельцам ПВУ Turkov с Home Assistant;
- тем, кто пишет automation/blueprint и упирается в "странное" поведение Jinja;
- тем, кто хочет переносимую логику, а не одноразовый скрипт "под себя";
- тем, кто хочет убрать риск опасных режимов в холодный период.

## TL;DR

Финальная версия проекта — `v0.5.3`. Я разделил blueprint на `pvu_min.yaml` (стабильная база) и `pvu.yaml` (полный режим с расширениями), добавил явные политики `away=off`, защиту от coupling fan/HVAC, post-check диагностику и прошел полевой beta-test по критичным сценариям (`home/away`, anti-flap, day/night).

## Зачем вообще было переделывать

На бумаге все выглядит легко: температура, качество воздуха, несколько условий - и готово.
Но в реальности именно здесь чаще всего и начинаются проблемы:

- автоматика не срабатывает из-за тонкостей Jinja;
- режимы применяются "вслепую", без проверки поддержки устройством;
- уставка температуры живет своей жизнью, если не отправлять `set_temperature`;
- вентиляция может включиться в холод при неудачной логике.

Цель была не "сделать умно", а сделать надежно и повторяемо.

## Что именно управляет blueprint

Логика разделена на 3 контура:

1. **Температурный контур (HVAC)**
   - расчет `target_temp` по day/night/away;
   - выбор `desired_hvac_mode` с гистерезисом.

2. **Контур качества воздуха (Fan)**
   - анализ CO2/PM2.5/VOC/NOx/влажности;
   - трехступенчатый выбор `low/medium/high`.

3. **Контур безопасности**
   - проверка `supported_hvac_modes` и `supported_fan_modes`;
   - антизаморозочная блокировка HVAC-вентиляции через `outdoor_vent_min`;
   - поведение при неизвестной наружной температуре через `outdoor_temp_policy`.

## Две ветки blueprint

- `pvu_min.yaml` — стабильная базовая ветка, приоритет совместимости и предсказуемости.
- `pvu.yaml` — развиваемая ветка с новыми возможностями и UX-улучшениями.

Такой подход позволяет безопасно использовать "минимум" в проде и отдельно развивать новые функции без риска поломать рабочий сценарий.

## Ключевые фиксы, которые реально поменяли поведение

### 1) Нормализация bool в шаблонах

`"false"` как строка в Jinja легко дает не то поведение, которое ожидаешь в условиях.
Поэтому введены явные булевы флаги (`is_day_bool`, `is_away_bool`), чтобы исключить "магическое" поведение.

### 2) Явная отправка целевой температуры

Если переключать только HVAC/FAN и не отправлять новую уставку, режим поддержания начинает "плавать".
Теперь перед сменой режима выполняется `climate.set_temperature` (когда уставка изменилась).

### 3) Антизаморозка в штатной логике

Кейс из реальной эксплуатации: на улице холодно, а автоматика уводит систему в `fan_only`.
Добавлен отдельный порог `outdoor_vent_min`, а при запрете вентиляции по холоду применяется безопасный fallback в `heat`.

### 4) Устойчивый presence fallback

Частый сценарий: выбран `presence_mode: alarm`, но сущность по факту `group.*`.
Добавлен fallback на `not_home/off`, если это не `alarm_control_panel`.

### 5) Безопасная политика при неизвестной `temp_outdoor`

Добавлен переключатель `outdoor_temp_policy`:

- `conservative` (по умолчанию) — не разрешает `cooling/fan_only`, если наружная температура неизвестна;
- `permissive` — оставляет прежнее поведение, когда ограничения по наружной температуре не применяются.

Это закрывает риск "слепого" включения режимов в холодный период при проблемах с наружным датчиком.

### 6) Встроенная диагностика (`debug_mode`)

В develop-ветке можно включить диагностические уведомления (`persistent_notification`) и видеть:

- текущие и целевые режимы;
- причины ограничений;
- ключевые флаги (`cool_allowed`, `vent_allowed`, `air_boost_count`).

## Как работает алгоритм по шагам

1. Определяет контекст: день/ночь, дома/никого, валидность датчиков.
2. Считает целевую температуру (`temp_day`, `temp_night`, `temp_away`).
3. Вводит ограничения по улице: `cool_allowed` и `vent_allowed`.
4. Выбирает `desired_hvac_mode` по приоритетам (`off` -> `cool` -> `heat` -> `fan_only` с учетом ограничений).
5. Считает интенсивность ухудшения воздуха и выбирает скорость вентилятора.
6. Применяет только нужные изменения и только поддерживаемые устройством.

## Что улучшилось в UI

В `pvu.yaml` поля сгруппированы в `input sections`:

- сущности и датчики;
- присутствие и расписание;
- температура и защита;
- качество воздуха и пороги;
- режимы и диагностика.

Секции открываются в свернутом виде по умолчанию, поэтому настройка стала заметно компактнее.

## Что появилось в Этапе 3

### 1) Профили климата

`climate_profile` меняет поведение температурного контура без ручной правки десятка порогов:

- `continental` — базовый сбалансированный вариант;
- `mild` — мягче ограничения и чуть более ранняя реакция;
- `cold` — более консервативная стратегия anti-freeze и выше устойчивость к "дребезгу".

### 2) Профили жилья

`home_profile` управляет чувствительностью к качеству воздуха:

- `house` — базовый профиль по умолчанию (менее агрессивный разгон);
- `apartment` — более чувствительный профиль относительно `house`;
- `office` — более строгий контроль IAQ.

### 3) Сопровождение "из коробки"

- дашборды: `airflow_dashboard.yaml`, `airflow_dashboard_min.yaml`;
- карточки для `Manual card`: `airflow_card.yaml`, `airflow_card_min.yaml`;
- KPI-пакет: `airflow_kpi_package.yaml` для оценки доли времени в целевой зоне по CO2/PM2.5/VOC/NOx.

## Почему эта схема полезна не только для Turkov

Даже при привязке к `hass-turkov`, архитектура остается переносимой:

- режимы задаются через входы blueprint;
- перед отправкой идет проверка поддержки;
- есть защита от "кривых" состояний датчиков и невалидной конфигурации.

За счет этого автоматику можно переносить на похожие установки без переписывания ядра логики.

## Что в результате релиза

После всех итераций и hotfix-циклов система стала:

- предсказуемой по trace в Home Assistant;
- устойчивой к ошибкам выбора сущностей и режимов;
- безопасной зимой;
- удобной в сопровождении и диагностике.

Отдельно зафиксировал ограничение среды: в зимних условиях `cool/fan_only` могут не применяться из-за устройства/интеграции, даже если команда отправлена корректно.

Релизы: <https://github.com/Gfermoto/hass-PVU/releases>  
Changelog: [`CHANGELOG.md`](../CHANGELOG.md)

## Статус проекта

На текущем этапе считаю проект завершенным как production-решение для моего сценария эксплуатации.

Что уже закреплено:

- политики поведения в `away=off` через `away_off_hvac_policy` и `away_off_fan_policy`;
- post-check диагностика через `command_verify_delay_sec`;
- release-checklist с интеграционными и сезонными сценариями;
- подтверждение критичных сценариев в полевом beta-test отчете.

## Финал

Если у вас похожий сценарий (ПВУ + Home Assistant), можно взять:

- `pvu_min.yaml` — если нужен максимально стабильный базовый контур;
- `pvu.yaml` — если нужен полный функционал, диагностика и тонкая настройка политик.
