# Как я довёл автоматику ПВУ Turkov в Home Assistant до состояния «можно жить»

Привет, Хабр.

Долго искал подходящую приточно-вытяжную установку; остановился на Turkov из-за интеграции с Home Assistant. Оказалось, что для нормального управления одной интеграции мало — нужна автоматизация, которая не дёргает режимы, не включает вентиляцию в мороз и предсказуемо ведёт себя при «никого нет дома». Собрал такую логику в Blueprint и довёл до рабочего состояния. Делюсь тем, что вынес из этого пути.

В статье — не «ещё один yaml», а разбор проблем, которые реально ломали поведение, и решений, которые сделали автоматику предсказуемой в эксплуатации.

Репозиторий: <https://github.com/Gfermoto/hass-PVU>

## Кому будет полезно

- владельцам ПВУ Turkov с Home Assistant (или другой установки с climate-сущностью в HA);
- тем, кто пишет automation/blueprint и упирается в «странное» поведение Jinja;
- тем, кто хочет переносимую логику, а не одноразовый скрипт под одну конфигурацию;
- тем, кто хочет убрать риск опасных режимов в холодный период.

## TL;DR

Два файла: `pvu_min.yaml` — минимальный стабильный контур; `pvu.yaml` — полная версия с профилями климата и жилья, антизаморозкой, anti-flap и явными политиками в режиме отсутствия. Для устройств, где «выключить вентилятор» тянет за собой выключение HVAC, добавлена политика `away_off_fan_policy` (можно не слать `fan_mode=off`). Есть post-check: если команда ушла, а состояние не изменилось через N секунд — в debug видно. Критичные сценарии (home/away, anti-flap, day/night) проверены в полевом beta-test. Текущее состояние — v0.5.3, проект для себя считаю завершённым.

## Зачем вообще было переделывать

На бумаге все выглядит легко: температура, качество воздуха, несколько условий - и готово.
Но в реальности именно здесь чаще всего и начинаются проблемы:

- автоматика не срабатывает из-за тонкостей Jinja;
- режимы применяются «вслепую», без проверки поддержки устройством;
- уставка температуры живет своей жизнью, если не отправлять `set_temperature`;
- вентиляция может включиться в холод при неудачной логике.

Цель была не «сделать умно», а сделать надёжно и повторяемо.

## Что именно управляет blueprint

Логика разделена на 3 контура:

1. **Температурный контур (HVAC)**
   - расчет `target_temp` по day/night/away;
   - выбор `desired_hvac_mode` с гистерезисом.

2. **Контур качества воздуха (Fan)**
   - анализ CO2/PM2.5/VOC/NOx/влажности;
   - трехступенчатый выбор `low/medium/high`.

3. **Контур безопасности**
   - проверка `supported_hvac_modes` и `supported_fan_modes`;
   - антизаморозочная блокировка HVAC-вентиляции через `outdoor_vent_min`;
   - поведение при неизвестной наружной температуре через `outdoor_temp_policy`.

## Два варианта blueprint

- `pvu_min.yaml` — минимальный набор: температурный контур, вентилятор, антизаморозка, проверка поддерживаемых режимов. Максимально консервативно.
- `pvu.yaml` — полная версия: всё то же плюс профили климата и жилья, политики в режиме отсутствия, anti-flap, плавный спад вентилятора и диагностика с post-check.

Оба варианта зафиксированы и готовы к использованию; разница только в количестве настроек и сценариев.

## Ключевые фиксы, которые реально поменяли поведение

### 1) Нормализация bool в шаблонах

`"false"` как строка в Jinja легко дает не то поведение, которое ожидаешь в условиях.
Поэтому введены явные булевы флаги (`is_day_bool`, `is_away_bool`), чтобы исключить «магическое» поведение.

### 2) Явная отправка целевой температуры

Если переключать только HVAC/FAN и не отправлять новую уставку, режим поддержания начинает «плавать».
Теперь перед сменой режима выполняется `climate.set_temperature` (когда уставка изменилась).

### 3) Антизаморозка в штатной логике

Кейс из реальной эксплуатации: на улице холодно, а автоматика уводит систему в `fan_only`.
Добавлен отдельный порог `outdoor_vent_min`, а при запрете вентиляции по холоду применяется безопасный fallback в `heat`.

### 4) Устойчивый presence fallback

Частый сценарий: выбран `presence_mode: alarm`, но сущность по факту `group.*`.
Добавлен fallback на `not_home/off`, если это не `alarm_control_panel`.

### 5) Безопасная политика при неизвестной `temp_outdoor`

Добавлен переключатель `outdoor_temp_policy`:

- `conservative` (по умолчанию) — не разрешает `cooling/fan_only`, если наружная температура неизвестна;
- `permissive` — оставляет прежнее поведение, когда ограничения по наружной температуре не применяются.

Это закрывает риск «слепого» включения режимов в холодный период при проблемах с наружным датчиком.

### 6) Встроенная диагностика (`debug_mode`)

В полной версии (`pvu.yaml`) можно включить диагностические уведомления (`persistent_notification`) и видеть:

- текущие и целевые режимы;
- причины, по которым режим не применён (`already_set`, `unsupported_mode`, `min_interval_hold` и др.);
- ключевые флаги (`cool_allowed`, `vent_allowed`, `air_boost_count`).

Опционально задаётся `command_verify_delay_sec`: через N секунд после отправки команды проверяется, совпал ли фактический state с целевым. Если нет — создаётся отдельное уведомление. Так можно отловить случаи, когда устройство или интеграция команду не приняли.

## Как работает алгоритм по шагам

1. Определяет контекст: день/ночь, дома/никого, валидность датчиков.
2. Считает целевую температуру (`temp_day`, `temp_night`, `temp_away`).
3. Вводит ограничения по улице: `cool_allowed` и `vent_allowed`.
4. Выбирает `desired_hvac_mode` по приоритетам (`off` -> `cool` -> `heat` -> `fan_only` с учетом ограничений).
5. Считает интенсивность ухудшения воздуха и выбирает скорость вентилятора.
6. Применяет только нужные изменения и только поддерживаемые устройством.

## Что улучшилось в UI

В `pvu.yaml` поля сгруппированы в `input sections`:

- сущности и датчики;
- присутствие и расписание;
- температура и защита;
- качество воздуха и пороги;
- режимы и диагностика.

Секции открываются в свернутом виде по умолчанию, поэтому настройка стала заметно компактнее.

## Что появилось в Этапе 3

### 1) Профили климата

`climate_profile` меняет поведение температурного контура без ручной правки десятка порогов:

- `continental` — базовый сбалансированный вариант;
- `mild` — мягче ограничения и чуть более ранняя реакция;
- `cold` — более консервативная стратегия anti-freeze и выше устойчивость к «дребезгу».

### 2) Профили жилья

`home_profile` управляет чувствительностью к качеству воздуха:

- `house` — базовый профиль по умолчанию (менее агрессивный разгон);
- `apartment` — более чувствительный профиль относительно `house`;
- `office` — более строгий контроль IAQ.

### 3) Сопровождение "из коробки"

- дашборды: `airflow_dashboard.yaml`, `airflow_dashboard_min.yaml`;
- карточки для `Manual card`: `airflow_card.yaml`, `airflow_card_min.yaml`;
- KPI-пакет: `airflow_kpi_package.yaml` для оценки доли времени в целевой зоне по CO2/PM2.5/VOC/NOx.

### 4) Политики в режиме отсутствия и защита от coupling

На части установок команда `fan_mode: off` по сути выключает и HVAC — получается обход anti-flap и неочевидное поведение при «никого нет дома». Поэтому в полной версии добавлены две отдельные политики:

- **`away_off_hvac_policy`** — когда переводить HVAC в `off`: сразу (`immediate`) или после истечения anti-flap интервала (`respect_min_interval`).
- **`away_off_fan_policy`** — отправлять ли `fan_mode=off` при уходе в away. Вариант `hvac_only` не шлёт команду вентилятору, только переводит HVAC в `off`, и устройство не «дёргается» из-за связки fan↔HVAC.

Так поведение в сценарии «поставили охрану — выключить установку» становится предсказуемым и настраиваемым под конкретное железо.

## Почему эта схема полезна не только для Turkov

Даже при привязке к `hass-turkov`, архитектура остается переносимой:

- режимы задаются через входы blueprint;
- перед отправкой идет проверка поддержки;
- есть защита от «кривых» состояний датчиков и невалидной конфигурации.

За счет этого автоматику можно переносить на похожие установки без переписывания ядра логики.

## Что в результате

После нескольких итераций и hotfix-циклов автоматика стала предсказуемой по trace, устойчивой к неверному выбору сущностей и режимов и безопасной в холодный период. Диагностика (`debug_mode` и post-check) помогает быстро понять, почему режим не применился или почему устройство «не послушалось».

Важное ограничение: в зимних условиях часть устройств или интеграций не принимает `cool` и `fan_only` даже при корректной команде — это уже не логика blueprint, а особенности железа или прошивки. В таком случае система остаётся в `heat` или текущем режиме.

По качеству воздуха можно использовать любые датчики (у меня, например, AirGradient) или обойтись без них — тогда управление вентилятором опирается только на температуру и влажность. Blueprint завязан на climate-сущность, так что теоретически подойдёт и к другим установкам с climate в HA; на практике проверял только на Turkov.

Релизы: <https://github.com/Gfermoto/hass-PVU/releases>  
Changelog: [`CHANGELOG.md`](../CHANGELOG.md)

## Вместо заключения

Для своего сценария я считаю проект завершённым: критичные сценарии (home/away, anti-flap, day/night) прошли полевую проверку, политики и диагностика зафиксированы в коде и документации.

Если у вас Turkov (или другая ПВУ с climate в HA) и Home Assistant — можно попробовать:

- `pvu_min.yaml` — минимальный стабильный контур;
- `pvu.yaml` — полный набор с профилями, политиками и отладкой.

Буду благодарен за обратную связь и отчёты с других установок: баги и предложения удобно оставлять в [Issues](https://github.com/Gfermoto/hass-PVU/issues).
