# Как я довел автоматику ПВУ Turkov в Home Assistant до состояния "можно жить"

Привет, Хабр.

Если коротко: это не "еще один yaml для умного дома". Это история про то, как довести автоматику до состояния, когда она не подводит в обычной жизни: держит комфорт, следит за воздухом и не делает опасных переключений зимой.

Показываю практический путь: как превратить "почти рабочую" автоматику ПВУ Turkov в предсказуемый релиз для реальной эксплуатации.

Проект: <https://github.com/Gfermoto/hass-PVU>

## Кому будет полезно

- владельцам ПВУ Turkov с Home Assistant;
- тем, кто пишет automation/blueprint и упирается в "странное" поведение Jinja;
- тем, кто хочет переносимую логику, а не одноразовый скрипт "под себя";
- тем, кто хочет убрать риск опасных режимов в холодный период.

## TL;DR

В релизе закрыты четыре болезненные проблемы: bool/string в шаблонах, отсутствие явного `set_temperature`, зимняя антизаморозка для `fan_only` и устойчивый fallback в presence-логике. После этого автоматика стала предсказуемой по trace и безопасной в повседневной эксплуатации.

## Зачем вообще было переделывать

На бумаге все выглядит легко: температура, качество воздуха, несколько условий - и готово.
Но в реальности именно здесь чаще всего и начинаются проблемы:

- автоматика не срабатывает из-за тонкостей Jinja;
- режимы применяются "вслепую", без проверки поддержки устройством;
- уставка температуры живет своей жизнью, если не отправлять `set_temperature`;
- вентиляция может включиться в холод при неудачной логике.

Цель была не "сделать умно", а сделать надежно и повторяемо.

## Что именно управляет blueprint

Логика разделена на 3 контура:

1. **Температурный контур (HVAC)**
   - расчет `target_temp` по day/night/away;
   - выбор `desired_hvac_mode` с гистерезисом.

2. **Контур качества воздуха (Fan)**
   - анализ CO2/PM2.5/VOC/NOx/влажности;
   - трехступенчатый выбор `low/medium/high`.

3. **Контур безопасности**
   - проверка `supported_hvac_modes` и `supported_fan_modes`;
   - антизаморозочная блокировка HVAC-вентиляции через `outdoor_vent_min`.

## Ключевые фиксы, которые реально поменяли поведение

### 1) Нормализация bool в шаблонах

`"false"` как строка в Jinja легко дает не то поведение, которое ожидаешь в условиях.
Поэтому введены явные булевы флаги (`is_day_bool`, `is_away_bool`), чтобы исключить "магическое" поведение.

### 2) Явная отправка целевой температуры

Если переключать только HVAC/FAN и не отправлять новую уставку, режим поддержания начинает "плавать".
Теперь перед сменой режима выполняется `climate.set_temperature` (когда уставка изменилась).

### 3) Антизаморозка в штатной логике

Кейс из реальной эксплуатации: на улице холодно, а автоматика уводит систему в `fan_only`.
Добавлен отдельный порог `outdoor_vent_min`, а при запрете вентиляции по холоду применяется безопасный fallback в `heat`.

### 4) Устойчивый presence fallback

Частый сценарий: выбран `presence_mode: alarm`, но сущность по факту `group.*`.
Добавлен fallback на `not_home/off`, если это не `alarm_control_panel`.

## Как работает алгоритм по шагам

1. Определяет контекст: день/ночь, дома/никого, валидность датчиков.
2. Считает целевую температуру (`temp_day`, `temp_night`, `temp_away`).
3. Вводит ограничения по улице: `cool_allowed` и `vent_allowed`.
4. Выбирает `desired_hvac_mode` по приоритетам (`off` -> `cool` -> `heat` -> `fan_only` с учетом ограничений).
5. Считает интенсивность ухудшения воздуха и выбирает скорость вентилятора.
6. Применяет только нужные изменения и только поддерживаемые устройством.

## Почему эта схема полезна не только для Turkov

Даже при привязке к `hass-turkov`, архитектура остается переносимой:

- режимы задаются через входы blueprint;
- перед отправкой идет проверка поддержки;
- есть защита от "кривых" состояний датчиков и невалидной конфигурации.

За счет этого автоматику можно переносить на похожие установки без переписывания ядра логики.

## Что в результате релиза

После фиксов система стала:

- предсказуемой по trace в Home Assistant;
- устойчивой к ошибкам выбора сущностей и режимов;
- безопасной зимой;
- удобной для дальнейшего расширения.

Релизы: <https://github.com/Gfermoto/hass-PVU/releases>  
Changelog: `CHANGELOG.md` в репозитории.

## Что дальше (roadmap)

- отдельные профили под климат/тип жилья;
- сервисный диагностический лог "почему режим не применен";
- автоматические тестовые сценарии на типовые edge-case.

## Финал

Если у вас похожий сценарий (ПВУ + Home Assistant), можно брать текущий blueprint как базу и спокойно адаптировать под свой набор датчиков и климат.

Если будет интерес, в следующем материале разберу "до/после" на конкретных фрагментах шаблонов и trace из Home Assistant: где ломалось и почему теперь работает стабильно.
