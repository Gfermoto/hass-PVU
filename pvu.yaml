blueprint:
  name: 'ПВУ Turkov: температура и качество воздуха (v0.2.4)'
  description: 'Универсальная автоматика ПВУ Turkov для Home Assistant.

    Обязательные датчики: температура и влажность в помещении.

    Остальные датчики (внутренние и наружные CO2/PM2.5/VOC/NO) опциональны в любой
    комбинации.

    Логика: внутренние датчики приоритетнее наружных; наружные используются как корректирующий
    фактор.

    Реализованы гистерезис, возврат к базовому режиму и защита от unavailable.

    '
  domain: automation
  input:
    turkov_climate:
      name: ПВУ Turkov (climate)
      description: Основная climate-сущность вашей ПВУ Turkov.
      selector:
        entity:
          domain:
          - climate
          multiple: false
          reorder: false
    temp_indoor:
      name: Температура в помещении
      description: Обязательный датчик. По нему выбирается нагрев/охлаждение.
      selector:
        entity:
          domain:
          - sensor
          device_class:
          - temperature
          multiple: false
          reorder: false
    humidity_indoor:
      name: Влажность в помещении
      description: Обязательный датчик. По нему включается/выключается усиленная вентиляция.
      selector:
        entity:
          domain:
          - sensor
          device_class:
          - humidity
          multiple: false
          reorder: false
    temp_outdoor:
      name: Температура снаружи
      default: []
      description: Опционально. Используется как ограничение включения cooling.
      selector:
        entity:
          domain:
          - sensor
          device_class:
          - temperature
          multiple: false
          reorder: false
    co2_sensor:
      name: CO2 в помещении
      default: []
      selector:
        entity:
          domain:
          - sensor
          device_class:
          - carbon_dioxide
          multiple: false
          reorder: false
    pm25_sensor:
      name: PM2.5 в помещении
      default: []
      selector:
        entity:
          domain:
          - sensor
          device_class:
          - pm25
          multiple: false
          reorder: false
    voc_sensor:
      name: VOC в помещении
      default: []
      selector:
        entity:
          domain:
          - sensor
          multiple: false
          reorder: false
    no_sensor:
      name: NOx в помещении
      default: []
      selector:
        entity:
          domain:
          - sensor
          multiple: false
          reorder: false
    co2_outdoor_sensor:
      name: CO2 снаружи
      default: []
      selector:
        entity:
          domain:
          - sensor
          device_class:
          - carbon_dioxide
          multiple: false
          reorder: false
    pm25_outdoor_sensor:
      name: PM2.5 снаружи
      default: []
      selector:
        entity:
          domain:
          - sensor
          device_class:
          - pm25
          multiple: false
          reorder: false
    voc_outdoor_sensor:
      name: VOC снаружи
      default: []
      selector:
        entity:
          domain:
          - sensor
          multiple: false
          reorder: false
    no_outdoor_sensor:
      name: NOx снаружи
      default: []
      selector:
        entity:
          domain:
          - sensor
          multiple: false
          reorder: false
    presence_home:
      name: Источник присутствия (опционально)
      default: []
      description: Можно выбрать binary_sensor / person / group / alarm_control_panel.
      selector:
        entity:
          domain:
          - binary_sensor
          - person
          - group
          - alarm_control_panel
          multiple: false
          reorder: false
    presence_mode:
      name: Логика присутствия
      description: Как считать «нет дома» для выбранной сущности присутствия.
      default: auto
      selector:
        select:
          options:
          - label: Авто (рекомендуется)
            value: auto
          - label: Binary Sensor (off = нет дома)
            value: binary_sensor
          - label: Person/Group (not_home = нет дома)
            value: person_group
          - label: Alarm (disarmed = дома, иначе нет дома)
            value: alarm
          - label: Пользовательское состояние (см. поле ниже)
            value: custom
    presence_away_state:
      name: Пользовательское состояние "нет дома"
      description: Используется только в режиме "Пользовательское состояние".
      default: not_home
      selector:
        text:
          multiline: false
          multiple: false
    away_behavior:
      name: Поведение в отсутствии
      description: Что делать, когда никого нет дома.
      default: maintain
      selector:
        select:
          options:
          - label: Поддерживать режим в отсутствии (temp_away)
            value: 'maintain'
          - label: Выключать установку
            value: 'off'
    schedule_day_start:
      name: 'День: начало'
      default: 07:00:00
      description: Время начала дневного режима.
      selector:
        time: {}
    schedule_night_start:
      name: 'Ночь: начало'
      default: '23:00:00'
      description: Время начала ночного режима.
      selector:
        time: {}
    temp_day:
      name: Целевая температура днем (°C)
      default: 22
      selector:
        number:
          min: 10.0
          max: 30.0
          step: 0.5
          mode: box
    temp_night:
      name: Целевая температура ночью (°C)
      default: 19
      selector:
        number:
          min: 10.0
          max: 30.0
          step: 0.5
          mode: box
    temp_away:
      name: Целевая температура в отсутствии (°C)
      default: 17
      selector:
        number:
          min: 10.0
          max: 30.0
          step: 0.5
          mode: box
    temp_hysteresis_on:
      name: 'Гистерезис: включение (°C)'
      default: 1.0
      description: Насколько температура должна отклониться от цели для смены режима.
      selector:
        number:
          min: 0.3
          max: 3.0
          step: 0.1
          mode: box
    temp_hysteresis_off:
      name: 'Гистерезис: возврат в норму (°C)'
      default: 0.5
      description: Зона возврата в нормальный режим вокруг целевой температуры.
      selector:
        number:
          min: 0.2
          max: 2.0
          step: 0.1
          mode: box
    outdoor_cool_min:
      name: 'Охлаждение: мин. t снаружи (°C)'
      default: 18
      description: Ниже этого значения охлаждение не включается.
      selector:
        number:
          min: -20.0
          max: 35.0
          step: 1.0
          mode: box
    humidity_high:
      name: 'Влажность: включить boost (%)'
      default: 70
      description: При достижении этого порога включается усиленная вентиляция (boost).
      selector:
        number:
          min: 30.0
          max: 95.0
          step: 1.0
          mode: box
    humidity_low:
      name: 'Влажность: выключить boost (%)'
      default: 60
      description: При снижении до этого порога усиленная вентиляция выключается.
      selector:
        number:
          min: 20.0
          max: 90.0
          step: 1.0
          mode: box
    co2_high:
      name: 'CO2: порог boost (ppm)'
      default: 1000
      selector:
        number:
          min: 400.0
          max: 2500.0
          step: 10.0
          mode: box
    co2_low:
      name: 'CO2: порог возврата (ppm)'
      default: 750
      selector:
        number:
          min: 350.0
          max: 2400.0
          step: 10.0
          mode: box
    co2_outdoor_block:
      name: 'CO2 снаружи: блок boost (ppm)'
      default: 1200
      selector:
        number:
          min: 400.0
          max: 5000.0
          step: 10.0
          mode: box
    pm25_high:
      name: 'PM2.5: порог boost (µg/m³)'
      default: 50
      selector:
        number:
          min: 5.0
          max: 300.0
          step: 1.0
          mode: box
    pm25_low:
      name: 'PM2.5: порог возврата (µg/m³)'
      default: 25
      selector:
        number:
          min: 3.0
          max: 250.0
          step: 1.0
          mode: box
    pm25_outdoor_block:
      name: 'PM2.5 снаружи: блок boost (µg/m³)'
      default: 100
      selector:
        number:
          min: 10.0
          max: 400.0
          step: 1.0
          mode: box
    voc_high:
      name: 'VOC: порог boost (ед. датчика)'
      default: 400
      selector:
        number:
          min: 10.0
          max: 3000.0
          step: 1.0
          mode: box
    voc_low:
      name: 'VOC: порог возврата (ед. датчика)'
      default: 300
      selector:
        number:
          min: 5.0
          max: 2500.0
          step: 1.0
          mode: box
    voc_outdoor_block:
      name: 'VOC снаружи: блок boost (ед. датчика)'
      default: 500
      selector:
        number:
          min: 10.0
          max: 5000.0
          step: 1.0
          mode: box
    no_high:
      name: 'NOx: порог boost'
      default: 20
      selector:
        number:
          min: 1.0
          max: 500.0
          step: 1.0
          mode: box
    no_low:
      name: 'NOx: порог возврата'
      default: 10
      selector:
        number:
          min: 1.0
          max: 500.0
          step: 1.0
          mode: box
    no_outdoor_block:
      name: 'NOx снаружи: блок boost'
      default: 20
      selector:
        number:
          min: 1.0
          max: 500.0
          step: 1.0
          mode: box
    fan_mode_low:
      name: 'Вентилятор: низкая скорость'
      default: low
      description: Базовая скорость вентилятора при нормальных условиях (рекомендовано low для Zenit Heco).
      selector:
        select:
          options:
          - label: low
            value: low
          - label: medium
            value: medium
          - label: high
            value: high
          - label: auto
            value: auto
          - label: 'off'
            value: 'off'
    fan_mode_medium:
      name: 'Вентилятор: средняя скорость'
      default: medium
      description: Средняя скорость при умеренном ухудшении воздуха или ограничении boost снаружи (рекомендовано medium).
      selector:
        select:
          options:
          - label: low
            value: low
          - label: medium
            value: medium
          - label: high
            value: high
          - label: auto
            value: auto
          - label: 'off'
            value: 'off'
    fan_mode_high:
      name: 'Вентилятор: высокая скорость'
      default: high
      description: Максимальная скорость при выраженном ухудшении воздуха/влажности (рекомендовано high).
      selector:
        select:
          options:
          - label: low
            value: low
          - label: medium
            value: medium
          - label: high
            value: high
          - label: auto
            value: auto
          - label: 'off'
            value: 'off'
    hvac_mode_ventilation:
      name: 'HVAC: вентиляция'
      default: fan_only
      description: Режим вентиляции в нормальных условиях (рекомендовано fan_only для Zenit Heco).
      selector:
        select:
          options:
          - label: fan_only
            value: fan_only
          - label: heat
            value: heat
          - label: cool
            value: cool
          - label: 'off'
            value: 'off'
    hvac_mode_heat:
      name: 'HVAC: нагрев'
      default: heat
      description: Режим нагрева (рекомендовано heat).
      selector:
        select:
          options:
          - label: heat
            value: heat
          - label: cool
            value: cool
          - label: fan_only
            value: fan_only
          - label: 'off'
            value: 'off'
    hvac_mode_cool:
      name: 'HVAC: охлаждение'
      default: cool
      description: Режим охлаждения (рекомендовано cool).
      selector:
        select:
          options:
          - label: cool
            value: cool
          - label: heat
            value: heat
          - label: fan_only
            value: fan_only
          - label: 'off'
            value: 'off'
  source_url: https://github.com/Gfermoto/hass-PVU/blob/main/pvu.yaml
trigger:
# Пересчёт каждые 2 минуты + при изменении обязательных датчиков.
- platform: time_pattern
  minutes: /2
- platform: state
  entity_id: !input temp_indoor
- platform: state
  entity_id: !input humidity_indoor
action:
- variables:
    # Вытаскиваем все blueprint input в локальные переменные
    # (чтобы дальше использовать короткие имена в шаблонах).
    turkov_climate: !input turkov_climate
    temp_indoor: !input temp_indoor
    humidity_indoor: !input humidity_indoor
    temp_outdoor: !input temp_outdoor
    co2_sensor: !input co2_sensor
    pm25_sensor: !input pm25_sensor
    voc_sensor: !input voc_sensor
    no_sensor: !input no_sensor
    co2_outdoor_sensor: !input co2_outdoor_sensor
    pm25_outdoor_sensor: !input pm25_outdoor_sensor
    voc_outdoor_sensor: !input voc_outdoor_sensor
    no_outdoor_sensor: !input no_outdoor_sensor
    presence_home: !input presence_home
    schedule_day_start: !input schedule_day_start
    schedule_night_start: !input schedule_night_start
    temp_day: !input temp_day
    temp_night: !input temp_night
    temp_away: !input temp_away
    temp_hysteresis_on: !input temp_hysteresis_on
    temp_hysteresis_off: !input temp_hysteresis_off
    outdoor_cool_min: !input outdoor_cool_min
    humidity_high: !input humidity_high
    humidity_low: !input humidity_low
    co2_high: !input co2_high
    co2_low: !input co2_low
    co2_outdoor_block: !input co2_outdoor_block
    pm25_high: !input pm25_high
    pm25_low: !input pm25_low
    pm25_outdoor_block: !input pm25_outdoor_block
    voc_high: !input voc_high
    voc_low: !input voc_low
    voc_outdoor_block: !input voc_outdoor_block
    no_high: !input no_high
    no_low: !input no_low
    no_outdoor_block: !input no_outdoor_block
    fan_mode_low: !input fan_mode_low
    fan_mode_medium: !input fan_mode_medium
    fan_mode_high: !input fan_mode_high
    hvac_mode_ventilation: !input hvac_mode_ventilation
    hvac_mode_heat: !input hvac_mode_heat
    hvac_mode_cool: !input hvac_mode_cool
    away_behavior: !input away_behavior
    presence_mode: !input presence_mode
    presence_away_state: !input presence_away_state
- variables:
    # === ВРЕМЯ / ДЕНЬ-НОЧЬ ===
    now_hms: '{{ now().strftime(''%H:%M:%S'') }}'
    day_start: '{{ (schedule_day_start + '':00'')[:8] if (schedule_day_start | string
      | length) == 5 else (schedule_day_start | string)[:8] }}'
    night_start: '{{ (schedule_night_start + '':00'')[:8] if (schedule_night_start
      | string | length) == 5 else (schedule_night_start | string)[:8] }}'
    is_day: "{% set ds = day_start %} {% set ns = night_start %} {% set t = now_hms
      %} {% if ds <= ns %}\n  {{ ds <= t and t < ns }}\n{% else %}\n  {{ t >= ds or
      t < ns }}\n{% endif %}\n"
    is_day_bool: '{{ (is_day | string | trim | lower) == ''true'' }}'
    # === ПРИСУТСТВИЕ ===
    # presence_mode:
    # - binary_sensor: off = нет дома
    # - person_group: not_home = нет дома
    # - alarm: armed_away/armed_vacation/triggered = нет дома
    # - custom: состояние presence_away_state = нет дома
    # - auto: безопасная эвристика по типовым состояниям
    presence_entity: '{{ presence_home | default('''', true) | string }}'
    presence_state: '{{ states(presence_entity) if ''.'' in presence_entity else '''' }}'
    is_away: >
      {% if '.' not in presence_entity %}
        {{ false }}
      {% elif presence_mode == 'binary_sensor' %}
        {{ is_state(presence_entity, 'off') }}
      {% elif presence_mode == 'person_group' %}
        {{ is_state(presence_entity, 'not_home') }}
      {% elif presence_mode == 'alarm' %}
        {{ is_state(presence_entity, 'armed_away') or is_state(presence_entity, 'armed_vacation') or is_state(presence_entity, 'triggered') }}
      {% elif presence_mode == 'custom' %}
        {% set away_state = (presence_away_state | string | trim) %}
        {{ away_state != '' and presence_state == away_state }}
      {% else %}
        {% if presence_state in ['not_home', 'off', 'armed_away', 'armed_vacation', 'triggered'] %}
          {{ true }}
        {% elif presence_state in ['home', 'on', 'disarmed', 'armed_home', 'armed_night', 'arming', 'pending'] %}
          {{ false }}
        {% else %}
          {{ false }}
        {% endif %}
      {% endif %}
    is_away_bool: '{{ (is_away | string | trim | lower) == ''true'' }}'
    target_temp: "{% if is_away_bool %}\n  {{ temp_away | float }}\n{% elif is_day_bool %}\n
      \ {{ temp_day | float }}\n{% else %}\n  {{ temp_night | float }}\n{% endif %}\n"
    # === ТЕМПЕРАТУРА ===
    temp_in_entity: '{{ temp_indoor | string }}'
    temp_in_valid: '{{ states(temp_in_entity) not in [''unknown'', ''unavailable'',
      ''none'', ''None'', ''''] }}'
    temp_in: '{{ states(temp_in_entity) | float(0) }}'
    temp_out_entity: '{{ temp_outdoor | default('''', true) | string }}'
    temp_out_valid: '{{ ''.'' in temp_out_entity and states(temp_out_entity) not in
      [''unknown'', ''unavailable'', ''none'', ''None'', ''''] }}'
    temp_out: '{{ states(temp_out_entity) | float(0) }}'
    cool_allowed: '{{ (not temp_out_valid) or (temp_out > outdoor_cool_min | float)
      }}'
    # === ВЛАЖНОСТЬ ===
    humidity_entity: '{{ humidity_indoor | string }}'
    humidity_active: '{{ states(humidity_entity) not in [''unknown'', ''unavailable'',
      ''none'', ''None'', ''''] }}'
    humidity_value: '{{ states(humidity_entity) | float(0) }}'
    humidity_boost: '{{ humidity_active and humidity_value >= (humidity_high | float)
      }}'
    humidity_clear: '{{ (not humidity_active) or humidity_value <= (humidity_low |
      float) }}'
    # === КАЧЕСТВО ВОЗДУХА (ВНУТРИ) ===
    co2_entity: '{{ co2_sensor | default('''', true) | string }}'
    co2_active: '{{ ''.'' in co2_entity and states(co2_entity) not in [''unknown'',
      ''unavailable'', ''none'', ''None'', ''''] }}'
    co2_value: '{{ states(co2_entity) | float(0) }}'
    co2_boost: '{{ co2_active and co2_value >= (co2_high | float) }}'
    co2_clear: '{{ (not co2_active) or co2_value <= (co2_low | float) }}'
    pm25_entity: '{{ pm25_sensor | default('''', true) | string }}'
    pm25_active: '{{ ''.'' in pm25_entity and states(pm25_entity) not in [''unknown'',
      ''unavailable'', ''none'', ''None'', ''''] }}'
    pm25_value: '{{ states(pm25_entity) | float(0) }}'
    pm25_boost: '{{ pm25_active and pm25_value >= (pm25_high | float) }}'
    pm25_clear: '{{ (not pm25_active) or pm25_value <= (pm25_low | float) }}'
    pm25_outdoor_entity: '{{ pm25_outdoor_sensor | default('''', true) | string }}'
    pm25_outdoor_active: '{{ ''.'' in pm25_outdoor_entity and states(pm25_outdoor_entity)
      not in [''unknown'', ''unavailable'', ''none'', ''None'', ''''] }}'
    pm25_outdoor_value: '{{ states(pm25_outdoor_entity) | float(0) }}'
    pm25_outdoor_bad: '{{ pm25_outdoor_active and pm25_outdoor_value >= (pm25_outdoor_block
      | float) }}'
    co2_outdoor_entity: '{{ co2_outdoor_sensor | default('''', true) | string }}'
    co2_outdoor_active: '{{ ''.'' in co2_outdoor_entity and states(co2_outdoor_entity)
      not in [''unknown'', ''unavailable'', ''none'', ''None'', ''''] }}'
    co2_outdoor_value: '{{ states(co2_outdoor_entity) | float(0) }}'
    co2_outdoor_bad: '{{ co2_outdoor_active and co2_outdoor_value >= (co2_outdoor_block
      | float) }}'
    voc_entity: '{{ voc_sensor | default('''', true) | string }}'
    voc_active: '{{ ''.'' in voc_entity and states(voc_entity) not in [''unknown'',
      ''unavailable'', ''none'', ''None'', ''''] }}'
    voc_value: '{{ states(voc_entity) | float(0) }}'
    voc_boost: '{{ voc_active and voc_value >= (voc_high | float) }}'
    voc_clear: '{{ (not voc_active) or voc_value <= (voc_low | float) }}'
    voc_outdoor_entity: '{{ voc_outdoor_sensor | default('''', true) | string }}'
    voc_outdoor_active: '{{ ''.'' in voc_outdoor_entity and states(voc_outdoor_entity)
      not in [''unknown'', ''unavailable'', ''none'', ''None'', ''''] }}'
    voc_outdoor_value: '{{ states(voc_outdoor_entity) | float(0) }}'
    voc_outdoor_bad: '{{ voc_outdoor_active and voc_outdoor_value >= (voc_outdoor_block
      | float) }}'
    no_entity: '{{ no_sensor | default('''', true) | string }}'
    no_active: '{{ ''.'' in no_entity and states(no_entity) not in [''unknown'', ''unavailable'',
      ''none'', ''None'', ''''] }}'
    no_value: '{{ states(no_entity) | float(0) }}'
    no_boost: '{{ no_active and no_value >= (no_high | float) }}'
    no_clear: '{{ (not no_active) or no_value <= (no_low | float) }}'
    # === КАЧЕСТВО ВОЗДУХА (СНАРУЖИ) ===
    # Эти параметры не "включают boost", а ограничивают его.
    no_outdoor_entity: '{{ no_outdoor_sensor | default('''', true) | string }}'
    no_outdoor_active: '{{ ''.'' in no_outdoor_entity and states(no_outdoor_entity)
      not in [''unknown'', ''unavailable'', ''none'', ''None'', ''''] }}'
    no_outdoor_value: '{{ states(no_outdoor_entity) | float(0) }}'
    no_outdoor_bad: '{{ no_outdoor_active and no_outdoor_value >= (no_outdoor_block
      | float) }}'
    any_air_boost: '{{ co2_boost or pm25_boost or voc_boost or no_boost }}'
    air_boost_count: "{{ (1 if co2_boost else 0)\n + (1 if pm25_boost else 0)\n + (1 if voc_boost else 0)\n + (1 if no_boost else 0)\n + (1 if humidity_boost else 0)\n}}"
    all_air_clear: '{{ co2_clear and pm25_clear and voc_clear and no_clear }}'
    outdoor_air_bad: '{{ pm25_outdoor_bad or co2_outdoor_bad or voc_outdoor_bad or
      no_outdoor_bad }}'
    # === ТЕКУЩЕЕ СОСТОЯНИЕ ПВУ ===
    current_hvac_mode: '{{ states(turkov_climate) | string }}'
    current_fan_mode: '{{ state_attr(turkov_climate, ''fan_mode'') | default('''',
      true) | string }}'
    supported_hvac_modes: '{{ state_attr(turkov_climate, ''hvac_modes'') | default([],
      true) }}'
    supported_fan_modes: '{{ state_attr(turkov_climate, ''fan_modes'') | default([],
      true) }}'
    desired_hvac_mode: "{% if is_away_bool and away_behavior == 'off' %}\n  off\n{% elif temp_in_valid and temp_in > (target_temp | float + temp_hysteresis_on |
      float) and cool_allowed %}\n  {{ hvac_mode_cool | string }}\n{% elif temp_in_valid
      and temp_in < (target_temp | float - temp_hysteresis_on | float) %}\n  {{ hvac_mode_heat
      | string }}\n{% elif humidity_clear and temp_in_valid and temp_in >= (target_temp
      | float - temp_hysteresis_off | float) and temp_in <= (target_temp | float +
      temp_hysteresis_off | float) %}\n  {{ hvac_mode_ventilation | string }}\n{% else
      %}\n  {{ '' }}\n{% endif %}\n"
    # Логика вентилятора (3 ступени):
    # 1) Если никого нет и выбран away=off -> off
    # 2) Если снаружи воздух плохой, ограничиваем разгон (max = medium)
    # 3) Если внутри выраженно плохо (>=2 триггера) -> high
    # 4) Если внутри умеренно плохо (1 триггер) -> medium
    # 5) Если всё чисто -> low
    desired_fan_mode: "{% set boost_count = air_boost_count | int(0) %}\n{% if is_away_bool and away_behavior == 'off' %}\n  off\n{% elif outdoor_air_bad and boost_count >= 1 %}\n  {{ fan_mode_medium | string }}\n{% elif outdoor_air_bad %}\n  {{ fan_mode_low | string }}\n{% elif boost_count >= 2 %}\n  {{ fan_mode_high | string }}\n{% elif boost_count == 1 %}\n  {{ fan_mode_medium | string }}\n{% elif all_air_clear and humidity_clear %}\n  {{ fan_mode_low | string }}\n{% else %}\n  {{ '' }}\n{% endif %}\n"
- choose:
  # Шаг 1: применяем HVAC только если режим действительно меняется.
  - conditions: '{{ (desired_hvac_mode | trim) | length > 0 and (desired_hvac_mode
      | trim) != current_hvac_mode
      and ((desired_hvac_mode | trim) in supported_hvac_modes
      or ((supported_hvac_modes | string | lower).find(desired_hvac_mode | trim |
      lower) != -1))
      }}'
    sequence:
    - service: climate.set_hvac_mode
      target:
        entity_id: !input turkov_climate
      data:
        hvac_mode: '{{ desired_hvac_mode | trim }}'
  default: []
- choose:
  # Шаг 2: применяем fan_mode только если режим действительно меняется.
  - conditions: '{{ (desired_fan_mode | trim) | length > 0 and (desired_fan_mode
      | trim) != current_fan_mode
      and ((desired_fan_mode | trim) in supported_fan_modes
      or ((supported_fan_modes | string | lower).find((desired_fan_mode | trim |
      lower)) != -1))
      }}'
    sequence:
    - service: climate.set_fan_mode
      target:
        entity_id: !input turkov_climate
      data:
        fan_mode: '{{ desired_fan_mode | trim }}'
  default: []
mode: single
